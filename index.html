<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pedidos - Chemes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeSlideUp 0.5s ease-out both; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-dark-900">

    <header class="bg-dark-800 border-b border-dark-700 shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-5">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-teal-400 to-teal-600 rounded-xl flex items-center justify-center shadow-lg shadow-teal-500/20">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-white">Estado de Pedidos</h1>
                        <p class="text-slate-400 text-sm">Dashboard E-commerce Chemes</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-dark-700 rounded-lg px-3 py-2 border border-dark-600">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-slate-300 text-sm">√öltimos 30 d√≠as</span>
                    </div>
                    <button id="btnActualizar" class="flex items-center gap-2 bg-teal-500 hover:bg-teal-400 text-dark-900 font-semibold px-4 py-2 rounded-lg transition-all shadow-lg shadow-teal-500/20">
                        <svg id="iconRefresh" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span class="text-sm">Actualizar</span>
                    </button>
                </div>
            </div>
            <div id="ultimaActualizacion" class="mt-3 text-xs text-slate-500"></div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <div id="errorMsg" class="hidden mb-6 bg-pink-500/10 border border-pink-500/30 text-pink-400 px-4 py-3 rounded-xl flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span id="errorText"></span>
        </div>

        <div id="metricas" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6"></div>
        <div id="flujoVisual" class="bg-dark-800 rounded-2xl border border-dark-700 p-6 mb-6 animate-fade"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-dark-800 rounded-2xl border border-dark-700 p-5">
                <h3 class="text-sm font-semibold text-white mb-3 text-center">√ìrdenes por Canal</h3>
                <div class="h-48"><canvas id="chartCanales"></canvas></div>
            </div>
            <div class="bg-dark-800 rounded-2xl border border-dark-700 p-5">
                <h3 class="text-sm font-semibold text-white mb-3 text-center">Top Vendedores</h3>
                <div class="h-48"><canvas id="chartVendedores"></canvas></div>
            </div>
            <div class="bg-dark-800 rounded-2xl border border-dark-700 p-5">
                <h3 class="text-sm font-semibold text-white mb-3 text-center">Estado Facturaci√≥n</h3>
                <div class="h-48"><canvas id="chartFacturacion"></canvas></div>
            </div>
            <div class="bg-dark-800 rounded-2xl border border-dark-700 p-5">
                <h3 class="text-sm font-semibold text-white mb-3 text-center">Estado Remisi√≥n</h3>
                <div class="h-48"><canvas id="chartRemision"></canvas></div>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                <span class="text-lg">üìå</span> Pendientes por Canal
            </h2>
            <div class="bg-dark-800 rounded-2xl border border-dark-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-dark-700 text-slate-400">
                            <tr>
                                <th class="text-left px-5 py-3 font-semibold">Canal</th>
                                <th class="text-right px-5 py-3 font-semibold">Pend. Facturar</th>
                                <th class="text-right px-5 py-3 font-semibold">$ Pend. Fact.</th>
                                <th class="text-right px-5 py-3 font-semibold">Sin Remitir</th>
                                <th class="text-right px-5 py-3 font-semibold">$ Pend. Rem.</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPendCanal" class="divide-y divide-dark-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Detalle por Canal
            </h2>
            <div id="canales" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                Detalle por Vendedor
            </h2>
            <div id="vendedores" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>

        <div class="mt-8 text-center text-sm text-slate-500">
            <p>Datos extra√≠dos de Tango Gesti√≥n - Talonarios e-commerce: 234, 205</p>
            <p class="mt-1">Dashboard para Control de facturaci√≥n y log√≠stica</p>
        </div>
    </main>

    <script>
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyaSUgKBwG8SR3RMdhogJ_1E73dFmChaTFwWu85XTn1EH6B2dTurlWpJa_2Oy2Agi7p/exec',
            USAR_DATOS_EJEMPLO: false
        };

        const DATOS_EJEMPLO = [
            { OrdenGrupo: 0, OrdenFila: 0, TipoAgrupacion: 'CANAL', Nombre: 'Mercado Libre', Ordenes: 1737, Facturadas: 1734, PendFacturar: 3, Remitidas: 1640, SinRemitir: 94, ImportePendFacturar: 510757.65, ImportePendRemitir: 26461638.92 },
            { OrdenGrupo: 0, OrdenFila: 0, TipoAgrupacion: 'CANAL', Nombre: 'PrestaShop', Ordenes: 630, Facturadas: 600, PendFacturar: 30, Remitidas: 545, SinRemitir: 55, ImportePendFacturar: 11924872.82, ImportePendRemitir: 21841134.00 },
            { OrdenGrupo: 0, OrdenFila: 0, TipoAgrupacion: 'CANAL', Nombre: 'Otros Canales', Ordenes: 91, Facturadas: 91, PendFacturar: 0, Remitidas: 82, SinRemitir: 9, ImportePendFacturar: 0, ImportePendRemitir: 4513240.91 },
            { OrdenGrupo: 0, OrdenFila: 1, TipoAgrupacion: 'CANAL', Nombre: '** TOTAL **', Ordenes: 2458, Facturadas: 2425, PendFacturar: 33, Remitidas: 2267, SinRemitir: 158, ImportePendFacturar: 12435630.47, ImportePendRemitir: 52816013.83 },
            { OrdenGrupo: 1, OrdenFila: 0, TipoAgrupacion: 'VENDEDOR', Nombre: 'MERCADO LIBRE', Ordenes: 1739, Facturadas: 1736, PendFacturar: 3, Remitidas: 1642, SinRemitir: 94, ImportePendFacturar: 510757.65, ImportePendRemitir: 26461638.92 },
            { OrdenGrupo: 1, OrdenFila: 0, TipoAgrupacion: 'VENDEDOR', Nombre: 'VENTAS WEB', Ordenes: 417, Facturadas: 393, PendFacturar: 24, Remitidas: 346, SinRemitir: 47, ImportePendFacturar: 10333633.82, ImportePendRemitir: 16982143.00 },
            { OrdenGrupo: 1, OrdenFila: 0, TipoAgrupacion: 'VENDEDOR', Nombre: 'SHOP BNA', Ordenes: 260, Facturadas: 254, PendFacturar: 6, Remitidas: 241, SinRemitir: 13, ImportePendFacturar: 1591239.00, ImportePendRemitir: 5828986.00 },
            { OrdenGrupo: 1, OrdenFila: 0, TipoAgrupacion: 'VENDEDOR', Nombre: 'ICBC MALL', Ordenes: 29, Facturadas: 29, PendFacturar: 0, Remitidas: 25, SinRemitir: 4, ImportePendFacturar: 0, ImportePendRemitir: 3543245.91 },
            { OrdenGrupo: 1, OrdenFila: 1, TipoAgrupacion: 'VENDEDOR', Nombre: '** TOTAL **', Ordenes: 2458, Facturadas: 2425, PendFacturar: 33, Remitidas: 2267, SinRemitir: 158, ImportePendFacturar: 12435630.47, ImportePendRemitir: 52816013.83 }
        ];

        var chartCanales, chartVendedores, chartFacturacion, chartRemision;

        const COLORES = {
            canales: ['#2dd4bf', '#a78bfa', '#60a5fa', '#f472b6'],
            vendedores: ['#2dd4bf', '#a78bfa', '#60a5fa', '#fbbf24', '#f472b6', '#4ade80'],
            facturacion: ['#2dd4bf', '#fbbf24'],
            remision: ['#60a5fa', '#f472b6']
        };

        function formatNumber(num) { return num.toLocaleString('es-AR'); }
        function formatCurrency(num) { return '$' + num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function calcularPorcentaje(valor, total) { return total > 0 ? ((valor / total) * 100).toFixed(1) : '0.0'; }
        function getCanalIcon(canal) {
            var icons = { 'Mercado Libre': 'üõí', 'PrestaShop': 'üõçÔ∏è', 'Web Chemes': 'üåê', 'Otros Canales': 'üì¶' };
            return icons[canal] || 'üì¶';
        }
        function getVendedorIcon(vendedor) { return vendedor === 'Carga inicial' ? '‚öôÔ∏è' : 'üë§'; }

        function renderGraficos(canales, vendedores, totales) {
            if (chartCanales) chartCanales.destroy();
            if (chartVendedores) chartVendedores.destroy();
            if (chartFacturacion) chartFacturacion.destroy();
            if (chartRemision) chartRemision.destroy();
            Chart.defaults.color = '#94a3b8';

            chartCanales = new Chart(document.getElementById('chartCanales').getContext('2d'), {
                type: 'doughnut',
                data: { labels: canales.map(function(c) { return c.Nombre; }), datasets: [{ data: canales.map(function(c) { return c.Ordenes; }), backgroundColor: COLORES.canales, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 }, color: '#94a3b8' } } } }
            });

            chartVendedores = new Chart(document.getElementById('chartVendedores').getContext('2d'), {
                type: 'doughnut',
                data: { labels: vendedores.slice(0, 5).map(function(v) { return v.Nombre.substring(0, 12); }), datasets: [{ data: vendedores.slice(0, 5).map(function(v) { return v.Ordenes; }), backgroundColor: COLORES.vendedores, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 }, color: '#94a3b8' } } } }
            });

            chartFacturacion = new Chart(document.getElementById('chartFacturacion').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Facturadas', 'Pendientes'], datasets: [{ data: [totales.facturadas, totales.pendFacturar], backgroundColor: COLORES.facturacion, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 }, color: '#94a3b8' } } } }
            });

            chartRemision = new Chart(document.getElementById('chartRemision').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Remitidas', 'Sin Remitir'], datasets: [{ data: [totales.remitidas, totales.sinRemitir], backgroundColor: COLORES.remision, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 }, color: '#94a3b8' } } } }
            });
        }

        function renderPendientesPorCanal(canales) {
            var ordenados = canales.slice().sort(function(a, b) {
                var aSin = Number(a.SinRemitir) || 0, bSin = Number(b.SinRemitir) || 0;
                if (bSin !== aSin) return bSin - aSin;
                return (Number(b.ImportePendRemitir) || 0) - (Number(a.ImportePendRemitir) || 0);
            });

            document.getElementById('tablaPendCanal').innerHTML = ordenados.map(function(c) {
                var pendFact = Number(c.PendFacturar) || 0, sinRem = Number(c.SinRemitir) || 0;
                var clsPendFact = pendFact > 0 ? 'text-amber-400 font-semibold' : 'text-slate-500';
                var clsSinRem = sinRem > 0 ? 'text-pink-400 font-semibold' : 'text-slate-500';
                return '<tr class="hover:bg-dark-700/50 transition-colors">' +
                    '<td class="px-5 py-3 text-white font-semibold">' + getCanalIcon(c.Nombre) + ' ' + c.Nombre + '</td>' +
                    '<td class="px-5 py-3 text-right ' + clsPendFact + '">' + formatNumber(pendFact) + '</td>' +
                    '<td class="px-5 py-3 text-right ' + clsPendFact + '">' + formatCurrency(Number(c.ImportePendFacturar) || 0) + '</td>' +
                    '<td class="px-5 py-3 text-right ' + clsSinRem + '">' + formatNumber(sinRem) + '</td>' +
                    '<td class="px-5 py-3 text-right ' + clsSinRem + '">' + formatCurrency(Number(c.ImportePendRemitir) || 0) + '</td>' +
                '</tr>';
            }).join('') || '<tr><td class="px-5 py-6 text-center text-slate-500" colspan="5">Sin datos</td></tr>';
        }
        
        function renderMetricas(totales) {
            var metricas = [
                { titulo: 'Total √ìrdenes', valor: totales.ordenes, subtitulo: '√öltimos 30 d√≠as', gradient: 'from-teal-500 to-teal-600', textColor: 'text-teal-400', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
                { titulo: 'Facturadas', valor: totales.facturadas, subtitulo: calcularPorcentaje(totales.facturadas, totales.ordenes) + '% del total', gradient: 'from-teal-500 to-teal-600', textColor: 'text-teal-400', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
                { titulo: 'Pend. Facturar', valor: totales.pendFacturar, subtitulo: formatCurrency(totales.importePendFact), gradient: 'from-amber-500 to-amber-600', textColor: 'text-amber-400', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
                { titulo: 'Remitidas', valor: totales.remitidas, subtitulo: calcularPorcentaje(totales.remitidas, totales.facturadas) + '% de fact.', gradient: 'from-blue-500 to-blue-600', textColor: 'text-blue-400', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' },
                { titulo: 'Sin Remitir', valor: totales.sinRemitir, subtitulo: formatCurrency(totales.importePendRem), gradient: 'from-pink-500 to-pink-600', textColor: 'text-pink-400', icon: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' }
            ];

            document.getElementById('metricas').innerHTML = metricas.map(function(m, i) {
                return '<div class="bg-dark-800 rounded-2xl border border-dark-700 hover:border-dark-600 transition-all overflow-hidden animate-fade" style="animation-delay:' + (i * 50) + 'ms">' +
                    '<div class="h-1 bg-gradient-to-r ' + m.gradient + '"></div><div class="p-5">' +
                    '<div class="flex items-center justify-between mb-3"><span class="text-sm font-medium text-slate-400 uppercase tracking-wide">' + m.titulo + '</span>' +
                    '<div class="p-2 rounded-xl bg-gradient-to-br ' + m.gradient + ' text-white shadow-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + m.icon + '"/></svg></div></div>' +
                    '<div class="text-3xl font-bold text-white mb-1">' + formatNumber(m.valor) + '</div><div class="text-sm ' + m.textColor + '">' + m.subtitulo + '</div></div></div>';
            }).join('');
        }

        function renderFlujoVisual(totales) {
            document.getElementById('flujoVisual').innerHTML = 
                '<h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-2"><svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>Flujo de Pedidos</h3>' +
                '<div class="flex items-center justify-between flex-wrap gap-4">' +
                '<div class="flex flex-col items-center flex-1 min-w-[100px]"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white shadow-lg shadow-teal-500/20 mb-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg></div><span class="text-2xl font-bold text-white">' + formatNumber(totales.ordenes) + '</span><span class="text-sm text-slate-400 mt-1">√ìrdenes</span></div>' +
                '<div class="hidden sm:block text-dark-600 text-2xl">‚Üí</div>' +
                '<div class="flex flex-col items-center flex-1 min-w-[100px]"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-violet-600 flex items-center justify-center text-white shadow-lg shadow-violet-500/20 mb-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><span class="text-2xl font-bold text-white">' + formatNumber(totales.facturadas) + '</span><span class="text-sm text-slate-400 mt-1">Facturadas</span></div>' +
                '<div class="hidden sm:block text-dark-600 text-2xl">‚Üí</div>' +
                '<div class="flex flex-col items-center flex-1 min-w-[100px]"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20 mb-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg></div><span class="text-2xl font-bold text-white">' + formatNumber(totales.remitidas) + '</span><span class="text-sm text-slate-400 mt-1">Remitidas</span></div></div>';
        }

        function renderFilaAgrupacion(item, tipo) {
            var icon = tipo === 'CANAL' ? getCanalIcon(item.Nombre) : getVendedorIcon(item.Nombre);
            var pctFact = calcularPorcentaje(item.Facturadas, item.Ordenes);
            var pctRem = calcularPorcentaje(item.Remitidas, item.Facturadas);
            var pendFact = Number(item.PendFacturar) || 0, sinRem = Number(item.SinRemitir) || 0;
            var impPendFact = Number(item.ImportePendFacturar) || 0, impPendRem = Number(item.ImportePendRemitir) || 0;

            var badgePendFact = pendFact > 0 ? '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-amber-500/10 text-amber-400 border border-amber-500/30">‚è≥ ' + formatNumber(pendFact) + ' <span class="font-normal">' + formatCurrency(impPendFact) + '</span></span>' : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-dark-700 text-slate-500 border border-dark-600">‚è≥ 0</span>';
            var badgeSinRem = sinRem > 0 ? '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-pink-500/10 text-pink-400 border border-pink-500/30">‚ö†Ô∏è ' + formatNumber(sinRem) + ' <span class="font-normal">' + formatCurrency(impPendRem) + '</span></span>' : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-dark-700 text-slate-500 border border-dark-600">‚ö†Ô∏è 0</span>';

            return '<div class="bg-dark-800 rounded-xl border border-dark-700 hover:border-dark-600 transition-all p-5">' +
                '<div class="flex items-center justify-between mb-4"><div class="flex items-center gap-3"><span class="text-2xl">' + icon + '</span><span class="text-lg font-semibold text-white">' + item.Nombre + '</span></div><span class="text-2xl font-bold text-teal-400">' + formatNumber(item.Ordenes) + '</span></div>' +
                '<div class="grid grid-cols-2 gap-4">' +
                '<div class="space-y-2"><div class="flex justify-between text-sm"><span class="text-slate-400">Facturaci√≥n</span><span class="font-medium text-teal-400">' + pctFact + '%</span></div><div class="w-full bg-dark-700 rounded-full h-2 overflow-hidden"><div class="h-full rounded-full bg-gradient-to-r from-teal-400 to-teal-500" style="width:' + pctFact + '%"></div></div><div class="flex justify-between text-xs text-slate-500"><span>‚úì ' + formatNumber(item.Facturadas) + '</span><span class="' + (pendFact > 0 ? 'text-amber-400 font-medium' : '') + '">‚è≥ ' + formatNumber(pendFact) + '</span></div></div>' +
                '<div class="space-y-2"><div class="flex justify-between text-sm"><span class="text-slate-400">Remisi√≥n</span><span class="font-medium text-blue-400">' + pctRem + '%</span></div><div class="w-full bg-dark-700 rounded-full h-2 overflow-hidden"><div class="h-full rounded-full bg-gradient-to-r from-blue-400 to-blue-500" style="width:' + pctRem + '%"></div></div><div class="flex justify-between text-xs text-slate-500"><span>üöö ' + formatNumber(item.Remitidas) + '</span><span class="' + (sinRem > 0 ? 'text-pink-400 font-medium' : '') + '">‚ö†Ô∏è ' + formatNumber(sinRem) + '</span></div></div></div>' +
                '<div class="mt-4 pt-4 border-t border-dark-700"><div class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Pendientes</div><div class="flex flex-wrap gap-2">' + badgePendFact + badgeSinRem + '</div></div></div>';
        }

        function renderDatos(datos) {
            var canales = datos.filter(function(d) { return d.TipoAgrupacion === 'CANAL' && d.OrdenFila === 0; });
            var vendedores = datos.filter(function(d) { return d.TipoAgrupacion === 'VENDEDOR' && d.OrdenFila === 0; });
            var totalCanales = datos.find(function(d) { return d.TipoAgrupacion === 'CANAL' && d.OrdenFila === 1; });

            var totales = {
                ordenes: totalCanales ? totalCanales.Ordenes : 0,
                facturadas: totalCanales ? totalCanales.Facturadas : 0,
                pendFacturar: totalCanales ? totalCanales.PendFacturar : 0,
                remitidas: totalCanales ? totalCanales.Remitidas : 0,
                sinRemitir: totalCanales ? totalCanales.SinRemitir : 0,
                importePendFact: totalCanales ? totalCanales.ImportePendFacturar : 0,
                importePendRem: totalCanales ? totalCanales.ImportePendRemitir : 0
            };

            renderMetricas(totales);
            renderFlujoVisual(totales);
            renderGraficos(canales, vendedores, totales);
            renderPendientesPorCanal(canales);
            document.getElementById('canales').innerHTML = canales.map(function(c) { return renderFilaAgrupacion(c, 'CANAL'); }).join('');
            document.getElementById('vendedores').innerHTML = vendedores.map(function(v) { return renderFilaAgrupacion(v, 'VENDEDOR'); }).join('');
            document.getElementById('ultimaActualizacion').textContent = '√öltima actualizaci√≥n: ' + new Date().toLocaleString('es-AR');
        }

        async function cargarDatos() {
            var btn = document.getElementById('btnActualizar');
            var icon = document.getElementById('iconRefresh');
            var errorDiv = document.getElementById('errorMsg');
            btn.disabled = true; icon.classList.add('animate-spin'); errorDiv.classList.add('hidden');

            try {
                var datos;
                if (CONFIG.USAR_DATOS_EJEMPLO) {
                    await new Promise(function(r) { setTimeout(r, 500); });
                    datos = DATOS_EJEMPLO;
                } else {
                    var response = await fetch(CONFIG.APPS_SCRIPT_URL);
                    if (!response.ok) throw new Error('Error');
                    var json = await response.json();
                    datos = json.data || json;
                }
                renderDatos(datos);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorText').textContent = 'Error al cargar los datos. Verifica la conexi√≥n.';
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false; icon.classList.remove('animate-spin');
            }
        }

        document.getElementById('btnActualizar').addEventListener('click', cargarDatos);
        cargarDatos();
        setInterval(cargarDatos, 5 * 60 * 1000);
    </script>
</body>
</html>
